<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 0 },
            debug: false,
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };
      var player;
      var legs;
      var gun;
      var input;
      var bullet;
      var mouse;
      var gunBack;
      var stars;
      var control = false;
      var bombs;
      var platforms;
      var cursors;
      var score = 0;
      var gameOver = false;
      var scoreText;

      var game = new Phaser.Game(config);

      function preload() {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('ground', 'assets/platform.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('lstar', 'assets/lstar.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.image('gun', 'assets/handwithgun.png');
        this.load.image('bullet', 'assets/bullet.png');
        this.load.image('gunback', 'assets/handswithgunback.png');
        this.load.spritesheet('dude', 'assets/spr.png', {
          frameWidth: 32,
          frameHeight: 32,
        });
        this.load.spritesheet('dudeLegs', 'assets/sprl.png', {
          frameWidth: 32,
          frameHeight: 32,
        });
      }

      function create() {
        input = this.input;
        mouse = this.input.mousePointer;
        this.add.image(400, 300, 'sky');
        platforms = this.physics.add.staticGroup();

        platforms
          .create(400, 568, 'ground')
          .setScale(2)
          .refreshBody();

        platforms.create(600, 400, 'ground');
        platforms.create(50, 250, 'ground').setRotation(0.2);
        platforms.create(750, 220, 'ground');

        // The player and its settings

        player = this.add.sprite(0, 0, 'dude');
        legs = this.add.sprite(0, 0, 'dudeLegs');
        gun = this.add.image(0, 1, 'gun').setOrigin(0, 0.5);

        person = this.add.container(150, 520, [legs, player, gun]);
        person.setSize(40, 32);
        this.physics.world.enable(person);

        person.body
          .setVelocity(0, 0)
          .setBounce(0, 0)
          .setCollideWorldBounds(true);

        this.anims.create({
          key: 'left',
          frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 5 }),
          frameRate: 10,
          repeat: -1,
        });
        this.anims.create({
          key: 'leftl',
          frames: this.anims.generateFrameNumbers('dudeLegs', {
            start: 0,
            end: 5,
          }),
          frameRate: 10,
          repeat: -1,
        });

        this.anims.create({
          key: 'turn',
          frames: [{ key: 'dude', frame: 10 }],
          frameRate: 20,
        });
        this.anims.create({
          key: 'turnl',
          frames: [{ key: 'dudeLegs', frame: 6 }],
          frameRate: 20,
        });

        this.anims.create({
          key: 'right',
          frames: this.anims.generateFrameNumbers('dude', {
            start: 6,
            end: 13,
          }),
          frameRate: 10,
          repeat: -1,
        });
        this.anims.create({
          key: 'rightl',
          frames: this.anims.generateFrameNumbers('dudeLegs', {
            start: 6,
            end: 13,
          }),
          frameRate: 10,
          repeat: -1,
        });

        //  Input Events
        cursors = this.input.keyboard.createCursorKeys();

        //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
        stars = this.physics.add.staticGroup();
        stars.create(200, 500, 'star');

        stars.children.iterate(function(child) {
          //  Give each star a slightly different bounce
          child.setBounceY(0.1);
        });

        //  Collide the player and the stars with the platforms
        // this.physics.add.collider(player, platforms);
        // this.physics.add.collider(legs, platforms);
        this.physics.add.collider(person, platforms);
        this.physics.add.collider(stars, platforms);

        //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
        this.physics.add.collider(person, stars, collectStar, null, this);
      }

      function update() {
        let angle = Phaser.Math.Angle.Between(
          person.list[2].x,
          person.list[2].y,
          input.x,
          input.y
        );
        if (mouse.isDown && control == false) {
          console.log('fire!');
          //for fire again

          bullet = this.physics.add.image(0, 0, 'bullet');
          person.add(bullet);

          //move to mouse position
          console.log([person.list, input.x, input.y]);
          this.physics.moveTo(person.list[3], input.x, input.y, 500);
          // control = true;
          // console.log(control);
        }
        // if (mouse.isUp) {
        //   console.log(control);
        //   control = false;
        // }

        if (gameOver) {
          return;
        }
        person.list[2].setRotation(angle - Math.PI / 6);
        gunBack = this.add.sprite(0, 1, 'gunback').setOrigin(1, 0.5);

        if (cursors.left.isDown) {
          person.body.setVelocityX(-50);
          person.replace(gun, gunBack);
          person.list[2].setRotation(-angle + Math.PI / 6);
          player.anims.play('left', true);
          legs.anims.play('leftl', true);
        } else if (cursors.right.isDown) {
          person.body.setVelocityX(50);
          // gun = this.add.image(4, 2, 'gun');
          person.replace(person.list[2], gun);

          player.anims.play('right', true);
          legs.anims.play('rightl', true);
        } else {
          person.body.setVelocityX(0);
          player.anims.play('turn', true);
          legs.anims.play('turnl', true);
        }

        if (cursors.up.isDown && person.body.touching.down) {
          person.body.setVelocityY(-330);
        }
      }

      function collectStar(player, star) {
        // star.disableBody(true, true);
      }
      function fff() {
        console.log('Есть стыковка');
      }
    </script>
  </body>
</html>
